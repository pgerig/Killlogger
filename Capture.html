<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Monitor Bluetooth</title>
<style>
body {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
    color: #00ff99;
    font-family: 'Courier New', monospace;
    padding: 20px;
    min-height: 100vh;
}
h2 {
    text-align: center;
    color: #00ffff;
    text-shadow: 0 0 10px #00ffff;
    margin-bottom: 30px;
}
.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
}
#log {
    white-space: pre-wrap;
    background: #000;
    padding: 15px;
    border: 2px solid #00ff99;
    border-radius: 8px;
    height: 400px;
    overflow-y: scroll;
    box-shadow: 0 0 20px rgba(0, 255, 153, 0.3);
    font-size: 14px;
    line-height: 1.4;
}
button {
    padding: 12px 24px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
    font-family: monospace;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}
#connect {
    background: linear-gradient(135deg, #00ff99 0%, #00cc77 100%);
    color: #000;
}
#connect:hover {
    background: linear-gradient(135deg, #00ffaa 0%, #00dd88 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 255, 153, 0.4);
}
#downloadTxt {
    background: linear-gradient(135deg, #00ccff 0%, #0099cc 100%);
    color: #000;
}
#downloadTxt:hover {
    background: linear-gradient(135deg, #00ddff 0%, #00aadd 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 204, 255, 0.4);
}
#downloadJson {
    background: linear-gradient(135deg, #ffcc00 0%, #ff9900 100%);
    color: #000;
}
#downloadJson:hover {
    background: linear-gradient(135deg, #ffdd00 0%, #ffaa00 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(255, 204, 0, 0.4);
}
#clearLog {
    background: linear-gradient(135deg, #ff3366 0%, #cc0033 100%);
    color: #fff;
}
#clearLog:hover {
    background: linear-gradient(135deg, #ff4477 0%, #dd0044 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(255, 51, 102, 0.4);
}
#log::-webkit-scrollbar {
    width: 10px;
}
#log::-webkit-scrollbar-track {
    background: #1a1a1a;
    border-radius: 5px;
}
#log::-webkit-scrollbar-thumb {
    background: #00ff99;
    border-radius: 5px;
}
#log::-webkit-scrollbar-thumb:hover {
    background: #00cc77;
}
</style>
</head>
<body>
<h2>Monitor en Tiempo Real (Bluetooth HC-05)</h2>
<div class="controls">
    <button id="connect">Conectar Bluetooth</button>
    <button id="downloadTxt">Descargar TXT</button>
    <button id="downloadJson">Descargar JSON</button>
    <button id="clearLog">Borrar Historial</button>
</div>
<div id="log"></div>
<script>
let port;
let reader;

async function conectarBluetooth() {
    try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        const decoder = new TextDecoderStream();
        const inputDone = port.readable.pipeTo(decoder.writable);
        const inputStream = decoder.readable;
        reader = inputStream.getReader();
        document.getElementById("log").innerHTML += "Conectado!\n";
        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
                document.getElementById("log").innerHTML += value;
                document.getElementById("log").scrollTop = 
                  document.getElementById("log").scrollHeight;
            }
        }
    } catch (e) {
        alert("Error: " + e);
    }
}

function descargarTXT() {
    const logContent = document.getElementById("log").innerText;
    const blob = new Blob([logContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'bluetooth_log_' + new Date().getTime() + '.txt';
    a.click();
    URL.revokeObjectURL(url);
}

function descargarJSON() {
    const logContent = document.getElementById("log").innerText;
    const logData = {
        timestamp: new Date().toISOString(),
        log: logContent.split('\n')
    };
    const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'bluetooth_log_' + new Date().getTime() + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function borrarHistorial() {
    if (confirm('¿Estás seguro de que quieres borrar todo el historial?')) {
        document.getElementById("log").innerHTML = '';
    }
}

document.getElementById("connect").addEventListener("click", conectarBluetooth);
document.getElementById("downloadTxt").addEventListener("click", descargarTXT);
document.getElementById("downloadJson").addEventListener("click", descargarJSON);
document.getElementById("clearLog").addEventListener("click", borrarHistorial);
</script>
</body>
</html>